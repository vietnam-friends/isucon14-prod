# ISUCON14 チーム運用ルール

## 基本方針

このドキュメントは、ISUCON14競技における開発・運用ルールを定めます。
効率的で安全な改善作業のため、以下のルールを厳守してください。

## 1. 変更管理ルール

### Git管理の徹底
- **全ての変更はローカル側で実施**し、git管理を行う
- サーバー側では`sudo git pull`でのみ変更を反映
- **サーバー側で直接ファイル編集は禁止**

### 変更フロー
```bash
# ローカルで変更
vim [ファイル]
git add [ファイル]
git commit -m "[変更内容]"
git push origin [ブランチ名]

# サーバーで反映
ssh [サーバー] "cd /home/isucon && sudo git pull origin [ブランチ名]"
```

## 2. サーバー接続情報

### ベンチマークサーバー
```bash
ssh -i ~/Downloads/isucon14.pem ubuntu@3.112.110.105
```

### アプリケーションサーバー
```bash
ssh -i ~/Downloads/isucon14.pem ubuntu@13.230.155.251
```

### SSH操作時の注意
- 設定変更後は必要なサービスを再起動
- systemdサービスの場合は`sudo systemctl daemon-reload`を忘れずに

## 3. エラー解析・ログ調査

### ログ確認方法
```bash
# アプリケーションログ（isuride-go）
sudo journalctl -u isuride-go -f

# 特定時間以降のログ
sudo journalctl -u isuride-go --since "5 minutes ago"

# エラーのみ抽出
sudo journalctl -u isuride-go | grep -E "ERROR|WARN"

# その他のサービス
sudo journalctl -u nginx -f
sudo journalctl -u isuride-matcher -f
sudo journalctl -u mysql -f
```

### ログ解析の手順
1. エラー発生時刻の特定
2. 関連するサービスのログを時系列で確認
3. エラーメッセージから根本原因を特定
4. 再現可能性の確認

## 4. ボトルネック分析・パフォーマンス改善

### AI エージェント分析システム 🤖

**推奨**: 手動分析の前に、AI エージェントによる自動分析を実行してください。

#### マスターエージェントの使用
```bash
# bottleneck-analyzer エージェントを呼び出し
# → 自動的にベンチマーク実行 + リソース監視 + ボトルネック判定 + 専門分析
```

#### エージェント階層構造
```
bottleneck-analyzer（マスター）
├── slow-query-analyzer      # DB分析専門
├── app-bottleneck-analyzer  # Go アプリ分析専門
└── [将来拡張可能]
```

#### 自動分析される内容
- **リソース監視**: CPU、メモリ、ディスクI/O、ネットワーク
- **ボトルネック判定**: CPU>80%, iowait>20%, メモリ>90% で専門エージェント呼び出し
- **DB分析**: スロークエリ（長時間・高頻度の2パターン）、N+1問題検出
- **アプリ分析**: Go pprof、メモリリーク、ゴルーチンリーク、コードレベルN+1検出

### 手動分析方法（エージェント分析で不足な場合）

#### 分析対象
- **DBスロークエリ**: MySQL slow query log
- **重いエンドポイント**: アクセスログの応答時間分析
- **リソース使用量**: CPU、メモリ、ディスクI/O
- **ネットワーク**: 通信遅延、タイムアウト

#### 手動分析コマンド
```bash
# MySQLスロークエリログ
sudo tail -f /var/log/mysql/mysql-slow.log

# nginxアクセスログから応答時間分析
sudo tail -f /var/log/nginx/access.log | awk '{print $NF, $7}' | sort -nr

# システムリソース確認
top
iostat 1
```

### 改善の優先順位
1. **🔴 Critical エラーの解消**（ベンチマーク失敗要因）
2. **🟡 High 頻度エンドポイントの最適化**
3. **🔵 Medium データベースクエリの最適化**  
4. **⚪ Low キャッシュの導入・改善**

**注意**: AI エージェントの分析結果は影響度で色分け・優先度付けされているため、それに従って実装してください。

## 5. 開発・テストフロー

### ブランチ戦略
```bash
# 新しい改善案の開始
git checkout main
git pull origin main
git checkout -b feature/[改善内容]

# 変更の実装
# ...

# コミット・プッシュ
git add .
git commit -m "[改善内容の詳細説明]"
git push origin feature/[改善内容]
```

### ベンチマーク実行・評価
```bash
# ベンチマーク実行
ssh -i ~/Downloads/isucon14.pem ubuntu@3.112.110.105 \
  "cd ~/isucon14/bench && /usr/local/go/bin/go run . run \
   --target https://xiv.isucon.net:443 \
   --payment-url http://13.230.155.251:12345 \
   -t 60 --skip-static-sanity-check"
```

### マージ条件
- ✅ ベンチマークスコアの向上が確認できた場合
- ✅ 新たなエラーが発生していない場合
- ✅ 既存機能に悪影響がない場合

```bash
# スコア向上確認後のマージ
git checkout main
git merge feature/[改善内容]
git push origin main

# アプリサーバーに反映
ssh [アプリサーバー] "cd /home/isucon && sudo git pull origin main"
```

## 6. Git Diff分析の徹底

### 変更前の必須確認
- **現在の状態**: `git status`, `git diff` で変更範囲を把握
- **影響範囲の予測**: どの機能に影響するかを事前に検討
- **最小限の変更**: 必要最小限の修正に留める

### エラー発生時の分析手順
1. **`git diff`を最初に確認** - 何を変更したかを正確に把握
2. **変更差分とエラーの関連性を分析** - どの変更がエラーの原因か特定
3. **段階的な切り戻し**: 一度に全て戻さず、段階的に原因を特定
4. **基盤部分の変更禁止**: 動作している基盤コードは不用意に触らない

### 変更管理のベストプラクティス
```bash
# 作業前の状態確認
git status
git diff

# 変更後の確認
git diff HEAD~1  # 直前のコミットとの差分
git log --oneline -5  # 最近の変更履歴

# エラー時の原因特定
git diff HEAD~1  # 最後の変更を確認
git show --name-only  # 変更されたファイル一覧
```

### 禁止事項
- ❌ **diffを見ずに広範囲を変更**
- ❌ **動作している基盤コードの不用意な修正**  
- ❌ **エラー原因をdiffで確認せずに推測で対応**
- ❌ **複数の機能を同時に変更**

## 7. 開発時の注意事項

### 修正範囲の制限
- **改修したい範囲に集中**し、基盤部分への影響を最小限に
- 1つのPRでは1つの改善に集中
- 副作用のリスクを常に考慮

### ステップバイステップ解決
1. 問題の切り分け
2. 最小限の修正で仮説検証
3. 段階的な改善
4. 各段階でのベンチマーク確認

### エラー対応の原則
- **まずgit diffで変更内容を確認**
- ログを必ず確認
- 再現手順の特定
- 根本原因の究明
- 対症療法ではなく原因治療

## 8. ドメイン知識管理

### 知識の蓄積場所
- **既存知識**: `docs/` ディレクトリ内のファイル
- **新たな発見**: `docs/` 配下に新規ファイル作成

### ドキュメント化対象
- API仕様の理解
- データベーススキーマの詳細
- ビジネスロジックの把握
- パフォーマンスボトルネックの発見
- 解決済み問題の記録

### ファイル命名規則
```
docs/
├── ISURIDE.md               # アプリケーション仕様書（既存）
├── manual.md                # 当日マニュアル（既存）
├── api-analysis.md          # API分析結果
├── database-schema.md       # DB構造理解
├── performance-issues.md    # パフォーマンス問題
├── troubleshooting.md       # トラブルシューティング履歴
└── business-logic.md        # ビジネスロジック理解
```

### 既存ドキュメント
- **manual.md**: ISUCON14当日マニュアル - 競技ルール、環境構築、ベンチマーカー仕様
- **ISURIDE.md**: ISURIDEアプリケーション仕様書 - ビジネスロジック、API仕様、データベース構造
- **logging-setup.md**: ログ設定手順 - AIエージェント動作に必要なログ設定

## 9. チェックリスト

### サーバー起動後の初期設定
- [ ] **ログ設定完了**: `sudo bash scripts/setup_logging.sh` 実行済み
- [ ] **pprof有効化**: `sudo bash scripts/enable_pprof.sh` 実行済み
- [ ] **ログ出力確認**: ベンチマーク実行後にログファイルが生成されることを確認済み

### 変更前
- [ ] ログ確認済み
- [ ] 現状のボトルネック特定済み
- [ ] 改善案の影響範囲確認済み
- [ ] ブランチ作成済み

### 変更後
- [ ] ローカルでgit管理済み
- [ ] サーバーで動作確認済み
- [ ] ベンチマーク実行済み
- [ ] スコア向上確認済み
- [ ] ログでエラー確認済み

### マージ前
- [ ] スコア向上確認済み
- [ ] 副作用なし確認済み
- [ ] ドキュメント更新済み（必要に応じて）

## 10. 開発時の基本原則

### 本来の目的と相手の意図を常に意識する

#### 目的確認の徹底
- **作業前に必ず確認**: 「何のために」この作業をするのか
- **手段の目的化を避ける**: ツールやスクリプト作成が目的になってはいけない
- **シンプルファースト**: 複雑な解決策の前に、まず単純な方法を検討

#### 相手の意図を汲み取る
- **表面的な言葉だけでなく文脈を理解**
- **不明な場合は確認**: 勝手に解釈して無駄な作業をしない
- **要求の背景を考える**: なぜそれが必要なのかを理解

---

**重要**: このルールに従わない変更は、システムの不安定化やスコア低下の原因となる可能性があります。必ず遵守してください。遵守しないと解雇通知が下る覚悟でいてください。